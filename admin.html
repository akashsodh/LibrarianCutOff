<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤</title>
    <style>
        :root { 
            --bg-color: #f0f2f5; 
            --text-color: #333; 
            --container-bg: #fff; 
            --header-bg: #37474f; 
            --suspect-bg: #fff3e0; 
            --btn-delete: #e53935;
            --btn-edit: #0288d1;
            --btn-rank: #4CAF50;
            --btn-save: #43a047;
            --btn-cancel: #757575;
            --btn-login: #1976d2;
            --btn-logout: #c62828;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 20px; 
            transition: background-color 0.3s; 
        }
        .container { 
            background-color: var(--container-bg); 
            padding: 20px 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            max-width: 1200px; 
            margin: auto; 
        }
        h1, h2 { 
            color: #d32f2f; 
            text-align: center; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        #login-form { 
            max-width: 400px; 
            margin: 40px auto; 
            padding: 30px; 
            border: 1px solid #ddd; 
        }
        #admin-panel { display: none; }
        input, select { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        button { 
            padding: 10px 15px; 
            border-radius: 4px; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            margin-left: 5px; 
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        .btn-login { background-color: var(--btn-login); width: 100%; }
        .btn-logout { background-color: var(--btn-logout); width: auto; position: absolute; top: 20px; right: 20px; }
        .btn-delete { background-color: var(--btn-delete); }
        .btn-edit { background-color: var(--btn-edit); }
        .btn-rank { background-color: var(--btn-rank); margin-bottom: 20px; }
        .btn-save { background-color: var(--btn-save); }
        .btn-cancel { background-color: var(--btn-cancel); }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: var(--header-bg); 
            color: white; 
        }
        .suspect-entry { 
            background-color: var(--suspect-bg); 
        }
        #error-message { 
            color: red; 
            text-align: center; 
            margin-bottom: 15px; 
            min-height: 1.2em;
        }
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content { 
            background-color: #fefefe; margin: 10% auto; padding: 30px; 
            border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; 
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-actions { text-align: right; margin-top: 20px; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body>

    <div id="app">
        <div id="login-container">
            <div class="container" id="login-form">
                <h2>üîí ‡§è‡§°‡§Æ‡§ø‡§® ‡§≤‡•â‡§ó‡§ø‡§®</h2>
                <div id="error-message"></div>
                <input type="email" id="email" placeholder="‡§à‡§Æ‡•á‡§≤" required>
                <input type="password" id="password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" required>
                <button id="loginBtn" class="btn-login">‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>

        <div id="admin-panel">
            <button id="logoutBtn" class="btn-logout">‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
            <div class="container">
                <h1>üõ°Ô∏è ‡§è‡§°‡§Æ‡§ø‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
                <button id="generateRankList" class="btn-rank">üèÜ ‡§∞‡•à‡§Ç‡§ï ‡§∏‡•Ç‡§ö‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç (CSV)</button>
                <table id="adminDataTable">
                    <thead>
                        <tr>
                            <th>‡§∞‡•à‡§Ç‡§ï</th>
                            <th>‡§®‡§æ‡§Æ</th>
                            <th>‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§ï</th>
                            <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
                            <th>‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</h3>
            <form id="editForm">
                <input type="hidden" id="editDocId">
                <label for="studentNameEdit">‡§®‡§æ‡§Æ:</label>
                <input type="text" id="studentNameEdit" required>
                
                <label for="paper1Edit">‡§™‡•á‡§™‡§∞ 1 ‡§ï‡•á ‡§Ö‡§Ç‡§ï:</label>
                <input type="number" id="paper1Edit" min="0" max="200" required>
                
                <label for="paper2Edit">‡§™‡•á‡§™‡§∞ 2 ‡§ï‡•á ‡§Ö‡§Ç‡§ï:</label>
                <input type="number" id="paper2Edit" min="0" max="200" required>

                <label for="categoryEdit">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</label>
                <select id="categoryEdit" required><option value="GENERAL">GENERAL</option><option value="OBC">OBC</option><option value="EWS">EWS</option><option value="MBC">MBC</option><option value="SC">SC</option><option value="ST">ST</option></select>
                
                <label for="areaEdit">‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</label>
                <select id="areaEdit" required><option value="TSP">TSP</option><option value="NON TSP">NON TSP</option></select>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button type="submit" class="btn-save">‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMZ3phZbfW_AfnynvDU_xjFxTnlzq8qCY",
            authDomain: "librariancutoff.firebaseapp.com",
            projectId: "librariancutoff",
            storageBucket: "librariancutoff.appspot.com",
            messagingSenderId: "712490455365",
            appId: "1:712490455365:web:f2e8d06043a2ed15b1ae2c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const studentsCollection = db.collection('students');

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('error-message');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        
        // --- Event Listeners ---
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            errorMessage.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    errorMessage.textContent = '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°‡•§';
                });
        });

        logoutBtn.addEventListener('click', () => auth.signOut());

        editForm.addEventListener('submit', saveChanges);

        document.getElementById('generateRankList').addEventListener('click', generateRankListCSV);

        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
        }

        // --- Auth State Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                loginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                loadAdminData();
            } else {
                loginContainer.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        });

        // --- Core Functions ---
        function loadAdminData() {
            studentsCollection.orderBy('totalMarks', 'desc').onSnapshot(snapshot => {
                const tableBody = document.getElementById('adminDataTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                let rank = 1;
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const docId = doc.id;
                    const isSuspect = !student.name || student.name.toLowerCase().trim() === 'test' || student.totalMarks < 100 || student.totalMarks > 400;

                    const row = tableBody.insertRow();
                    if (isSuspect) {
                        row.classList.add('suspect-entry');
                        row.title = '‡§Ø‡§π ‡§è‡§ï ‡§∏‡§Ç‡§¶‡§ø‡§ó‡•ç‡§ß ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à (‡§ú‡•à‡§∏‡•á ‡§®‡§æ‡§Æ ‡§Ø‡§æ ‡§Ö‡§Ç‡§ï ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡§Ç)‡•§';
                    }
                    row.innerHTML = `
                        <td>${rank++}</td>
                        <td>${student.name}</td>
                        <td><strong>${student.totalMarks}</strong></td>
                        <td>${student.category} - ${student.area}</td>
                        <td>
                            <button class="btn-edit" onclick='openEditModal("${docId}")'>‡§è‡§°‡§ø‡§ü</button>
                            <button class="btn-delete" onclick="deleteEntry('${docId}')">‡§π‡§ü‡§æ‡§è‡§Ç</button>
                        </td>
                    `;
                });
            }, error => console.error("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error));
        }

        async function openEditModal(docId) {
            try {
                const docRef = studentsCollection.doc(docId);
                const doc = await docRef.get();
                if (!doc.exists) return;
                
                const student = doc.data();
                document.getElementById('editDocId').value = docId;
                document.getElementById('studentNameEdit').value = student.name;
                document.getElementById('paper1Edit').value = student.paper1;
                document.getElementById('paper2Edit').value = student.paper2;
                document.getElementById('categoryEdit').value = student.category;
                document.getElementById('areaEdit').value = student.area;
                
                editModal.style.display = 'block';
            } catch (error) {
                console.error("‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
            }
        }
        
        function closeEditModal() {
            editModal.style.display = 'none';
        }

        async function saveChanges(e) {
            e.preventDefault();
            
            const docId = document.getElementById('editDocId').value;
            const paper1 = parseInt(document.getElementById('paper1Edit').value);
            const paper2 = parseInt(document.getElementById('paper2Edit').value);

            const updatedData = {
                name: document.getElementById('studentNameEdit').value.trim(),
                paper1: paper1,
                paper2: paper2,
                totalMarks: paper1 + paper2,
                category: document.getElementById('categoryEdit').value,
                area: document.getElementById('areaEdit').value,
            };

            try {
                await studentsCollection.doc(docId).update(updatedData);
                closeEditModal();
            } catch (error) {
                console.error("‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                alert("‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            }
        }
        
        function deleteEntry(docId) {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§')) {
                studentsCollection.doc(docId).delete()
                    .catch(error => alert("‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à: " + error.message));
            }
        }
        
        function generateRankListCSV() {
            let csvContent = "‡§∞‡•à‡§Ç‡§ï,‡§®‡§æ‡§Æ,‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§ï,‡§∂‡•ç‡§∞‡•á‡§£‡•Ä,‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞\n";
            let rank = 1;
            studentsCollection.orderBy('totalMarks', 'desc').get().then(snapshot => {
                snapshot.forEach(doc => {
                    const s = doc.data();
                    const name = `"${s.name.replace(/"/g, '""')}"`; // Handle names with quotes
                    csvContent += `${rank++},${name},${s.totalMarks},${s.category},${s.area}\n`;
                });
                downloadCSV(csvContent, "merit_list.csv");
            });
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
