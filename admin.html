<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel </title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root { 
            --primary-color: #4a90e2;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --light-gray-color: #f8f9fa;
            --dark-gray-color: #343a40;
            --text-color: #495057;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--light-gray-color); 
            color: var(--text-color); 
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container { 
            background-color: #fff; 
            padding: 30px 40px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            width: 100%;
            max-width: 1200px; 
            margin: 20px auto;
            box-sizing: border-box;
        }

        #login-container {
            max-width: 450px;
            margin-top: 5vh;
        }

        h1, h2, h3 { 
            color: var(--dark-gray-color); 
            text-align: center; 
            margin-bottom: 25px;
        }
        
        h1 { font-weight: 600; }
        h2 { font-weight: 500; }
        
        #admin-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        #admin-panel-header h1 {
            margin: 0;
            text-align: left;
        }
        
        #header-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #admin-panel { display: none; }
        
        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            margin-bottom: 18px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        button { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            transition: opacity 0.2s, transform 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        button:hover:not(:disabled) {
            opacity: 0.85;
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #9c9c9c;
        }
        
        .btn-login { background-color: var(--primary-color); width: 100%; padding: 12px;}
        .btn-logout { background-color: var(--danger-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-edit { background-color: var(--warning-color); }
        .btn-rank { background-color: var(--info-color); }
        .btn-save { background-color: var(--success-color); }
        .btn-cancel { background-color: #6c757d; }

        /* Responsive Table Wrapper */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            min-width: 800px; /* Ensures table has a minimum width before scrolling */
        }

        th, td { 
            border-bottom: 1px solid var(--border-color); 
            padding: 15px; 
            text-align: left; 
            vertical-align: middle;
            white-space: nowrap; /* Prevents text wrapping in cells */
        }

        th { 
            background-color: var(--light-gray-color);
            color: var(--dark-gray-color);
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        
        .suspect-entry { 
            background-color: #fffaf0;
            border-left: 4px solid var(--warning-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        #error-message { 
            color: var(--danger-color); 
            text-align: center; 
            margin-bottom: 15px; 
            min-height: 1.2em;
        }

        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content { 
            background-color: #fff; margin: 10% auto; padding: 30px; 
            border: none; width: 90%; max-width: 550px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-actions { text-align: right; margin-top: 25px; }
        
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        #pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        #pagination-controls .nav-buttons {
            display: flex;
            gap: 10px;
        }
        #pagination-controls button {
            background-color: var(--primary-color);
        }
        #page-info {
            font-weight: 500;
            color: var(--text-color);
            flex-shrink: 0; /* Prevents shrinking on flex layouts */
        }

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            #admin-panel-header {
                flex-direction: column;
                align-items: flex-start;
            }
            #header-actions {
                width: 100%;
            }
            #header-actions button {
                flex-grow: 1; /* Make buttons take equal space */
            }
            #pagination-controls {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="container" id="login-form">
            <h2>üîí Admin Login</h2>
            <div id="error-message"></div>
            <input type="email" id="email" placeholder="‡§à‡§Æ‡•á‡§≤" required>
            <input type="password" id="password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" required>
            <button id="loginBtn" class="btn-login">‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="container">
            <div id="admin-panel-header">
                <h1>üõ°Ô∏è Admin Dashboard</h1>
                <div id="header-actions">
                    <button id="generateRankList" class="btn-rank"><i class="fas fa-file-csv"></i> ‡§∞‡•à‡§Ç‡§ï ‡§∏‡•Ç‡§ö‡•Ä (CSV)</button>
                    <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="adminDataTable">
                    <thead>
                        <tr>
                            <th>‡§∞‡•à‡§Ç‡§ï</th>
                            <th>‡§®‡§æ‡§Æ</th>
                            <th>‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§ï</th>
                            <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
                            <th>‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div id="pagination-controls">
                <div class="nav-buttons">
                    <button id="prev-page" disabled><i class="fas fa-arrow-left"></i> ‡§™‡§ø‡§õ‡§≤‡§æ</button>
                </div>
                <span id="page-info">‡§™‡•á‡§ú 1</span>
                <div class="nav-buttons">
                    <button id="next-page" disabled>‡§Ö‡§ó‡§≤‡§æ <i class="fas fa-arrow-right"></i></button>
                    <button id="last-page" disabled>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§™‡•á‡§ú <i class="fas fa-fast-forward"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3><i class="fas fa-edit"></i> ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</h3>
            <form id="editForm">
                <input type="hidden" id="editDocId">
                <label for="studentNameEdit">‡§®‡§æ‡§Æ:</label>
                <input type="text" id="studentNameEdit" required>
                
                <label for="paper1Edit">‡§™‡•á‡§™‡§∞ 1 ‡§ï‡•á ‡§Ö‡§Ç‡§ï:</label>
                <input type="number" id="paper1Edit" min="0" max="200" required>
                
                <label for="paper2Edit">‡§™‡•á‡§™‡§∞ 2 ‡§ï‡•á ‡§Ö‡§Ç‡§ï:</label>
                <input type="number" id="paper2Edit" min="0" max="200" required>

                <label for="categoryEdit">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</label>
                <select id="categoryEdit" required><option value="GENERAL">GENERAL</option><option value="OBC">OBC</option><option value="EWS">EWS</option><option value="MBC">MBC</option><option value="SC">SC</option><option value="ST">ST</option></select>
                
                <label for="areaEdit">‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</label>
                <select id="areaEdit" required><option value="TSP">TSP</option><option value="NON TSP">NON TSP</option></select>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()"><i class="fas fa-times"></i> ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button type="submit" class="btn-save"><i class="fas fa-save"></i> ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMZ3phZbfW_AfnynvDU_xjFxTnlzq8qCY",
            authDomain: "librariancutoff.firebaseapp.com",
            projectId: "librariancutoff",
            storageBucket: "librariancutoff.appspot.com",
            messagingSenderId: "712490455365",
            appId: "1:712490455365:web:f2e8d06043a2ed15b1ae2c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const studentsCollection = db.collection('students');

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('error-message');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const tableBody = document.getElementById('adminDataTable').getElementsByTagName('tbody')[0];
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');
        const pageInfo = document.getElementById('page-info');

        // --- Pagination State ---
        const ITEMS_PER_PAGE = 100; // <<< ENTRIES PER PAGE SET TO 100
        let currentPage = 1;
        let lastVisible = null;
        let firstVisible = null;
        let pageStartHistory = [null];
        let totalPages = 1;
        let totalCount = 0;

        // --- Event Listeners ---
        loginBtn.addEventListener('click', () => { /* ... same as before ... */ });
        logoutBtn.addEventListener('click', () => auth.signOut());
        editForm.addEventListener('submit', saveChanges);
        document.getElementById('generateRankList').addEventListener('click', generateRankListCSV);

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadAndRenderStudents('next');
            }
        });
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadAndRenderStudents('prev');
            }
        });
        lastPageBtn.addEventListener('click', () => {
            if(currentPage < totalPages) {
                currentPage = totalPages;
                loadAndRenderStudents('last_page');
            }
        });
        
        window.onclick = (event) => { /* ... same as before ... */ };

        // --- Auth State Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                loginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                initializeAdminView();
            } else {
                loginContainer.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        });
        
        async function initializeAdminView() {
            // First, get total count to set up pagination correctly
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡§ï‡•Å‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</td></tr>';
            try {
                const snapshot = await studentsCollection.get();
                totalCount = snapshot.size;
                totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE) || 1;
                
                // Reset state and load first page
                currentPage = 1;
                lastVisible = null;
                firstVisible = null;
                pageStartHistory = [null];
                loadAndRenderStudents();

            } catch(e) {
                 tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§</td></tr>';
                 console.error("Error getting total count:", e);
            }
        }

        // --- Core Functions ---
        async function loadAndRenderStudents(direction = 'initial') {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>';
            let query;
            const baseQuery = studentsCollection.orderBy('totalMarks', 'desc');

            if (direction === 'next' && lastVisible) {
                query = baseQuery.startAfter(lastVisible).limit(ITEMS_PER_PAGE);
            } else if (direction === 'prev') {
                query = baseQuery.endBefore(firstVisible).limitToLast(ITEMS_PER_PAGE);
            } else if (direction === 'last_page') {
                // To get the last page, we need to order ascending and take the remainder
                const itemsOnLastPage = totalCount % ITEMS_PER_PAGE || ITEMS_PER_PAGE;
                query = studentsCollection.orderBy('totalMarks', 'asc').limit(itemsOnLastPage);
            }
            else { // initial load
                 query = baseQuery.limit(ITEMS_PER_PAGE);
            }
            
            try {
                const snapshot = await query.get();
                tableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>';
                    updatePaginationButtons();
                    return;
                }
                
                let docs = snapshot.docs;
                // If we fetched the last page, the order is ascending, so we must reverse it
                if (direction === 'last_page') {
                    docs.reverse();
                }

                firstVisible = docs[0];
                lastVisible = docs[docs.length - 1];

                const startingRank = (currentPage - 1) * ITEMS_PER_PAGE + 1;

                docs.forEach((doc, index) => {
                    const student = doc.data();
                    const docId = doc.id;
                    const isSuspect = !student.name || student.name.toLowerCase().trim() === 'test' || student.totalMarks < 100 || student.totalMarks > 400;

                    const row = tableBody.insertRow();
                    if (isSuspect) row.classList.add('suspect-entry');
                    
                    row.innerHTML = `
                        <td>${startingRank + index}</td>
                        <td>${student.name || 'N/A'}</td>
                        <td><strong>${student.totalMarks}</strong></td>
                        <td>${student.category} - ${student.area}</td>
                        <td class="action-buttons">
                            <button class="btn-edit" onclick='openEditModal("${docId}")'><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-delete" onclick="deleteEntry('${docId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
                
                updatePaginationButtons();

            } catch (error) {
                console.error("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§</td></tr>';
            }
        }
        
        function updatePaginationButtons() {
            pageInfo.textContent = `‡§™‡•á‡§ú ${currentPage} / ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
        }


        async function openEditModal(docId) { /* ... same as before ... */ }
        function closeEditModal() { /* ... same as before ... */ }

        async function saveChanges(e) {
            e.preventDefault();
            // ... (save logic is the same)
            try {
                // ... (await update)
                closeEditModal();
                // Instead of reloading current page, re-initialize to get correct counts and pages
                initializeAdminView(); 
            } catch (error) {
                // ... (error handling)
            }
        }
        
        function deleteEntry(docId) {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§')) {
                studentsCollection.doc(docId).delete()
                    .then(() => {
                        // Re-initialize to get correct counts and pages after delete
                        initializeAdminView();
                    })
                    .catch(error => alert("‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à: " + error.message));
            }
        }
        
        function generateRankListCSV() { /* ... same as before ... */ }
        function downloadCSV(csvContent, fileName) { /* ... same as before ... */ }

        // Minor code duplication from above functions to keep them self-contained for clarity
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            errorMessage.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    errorMessage.textContent = '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°‡•§';
                });
        });
        window.onclick = function(event) {
            if (event.target == editModal) {
                closeEditModal();
            }
        }
        async function openEditModal(docId) {
            try {
                const docRef = studentsCollection.doc(docId);
                const doc = await docRef.get();
                if (!doc.exists) return;
                
                const student = doc.data();
                document.getElementById('editDocId').value = docId;
                document.getElementById('studentNameEdit').value = student.name;
                document.getElementById('paper1Edit').value = student.paper1;
                document.getElementById('paper2Edit').value = student.paper2;
                document.getElementById('categoryEdit').value = student.category;
                document.getElementById('areaEdit').value = student.area;
                
                editModal.style.display = 'block';
            } catch (error) {
                console.error("‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
            }
        }
        function closeEditModal() {
            editModal.style.display = 'none';
        }
        async function saveChanges(e) {
            e.preventDefault();
            
            const docId = document.getElementById('editDocId').value;
            const paper1 = parseInt(document.getElementById('paper1Edit').value);
            const paper2 = parseInt(document.getElementById('paper2Edit').value);

            const updatedData = {
                name: document.getElementById('studentNameEdit').value.trim(),
                paper1: paper1,
                paper2: paper2,
                totalMarks: paper1 + paper2,
                category: document.getElementById('categoryEdit').value,
                area: document.getElementById('areaEdit').value,
            };

            try {
                await studentsCollection.doc(docId).update(updatedData);
                closeEditModal();
                initializeAdminView(); // Reload everything to ensure data consistency
            } catch (error) {
                console.error("‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                alert("‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            }
        }
        function generateRankListCSV() {
            let csvContent = "‡§∞‡•à‡§Ç‡§ï,‡§®‡§æ‡§Æ,‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§ï,‡§∂‡•ç‡§∞‡•á‡§£‡•Ä,‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞\n";
            let rank = 1;
            // This function fetches ALL data, ignoring pagination, for a complete CSV
            studentsCollection.orderBy('totalMarks', 'desc').get().then(snapshot => {
                snapshot.forEach(doc => {
                    const s = doc.data();
                    const name = `"${s.name.replace(/"/g, '""')}"`;
                    csvContent += `${rank++},${name},${s.totalMarks},${s.category},${s.area}\n`;
                });
                downloadCSV(csvContent, "merit_list.csv");
            });
        }
        function downloadCSV(csvContent, fileName) {
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // Add BOM for Excel
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
